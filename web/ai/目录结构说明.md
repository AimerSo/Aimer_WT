# AI助手模块目录结构说明

本文档详细说明AI助手模块的文件组织结构及各文件功能定位。

---

## 目录概览

```
ai/
├── 目录结构说明.md          # 本文档
├── config.js                # 全局配置管理
├── ai_chat.css              # 聊天框样式
├── ai_chat.js               # 聊天框UI逻辑
├── index.js                 # 模块入口
├── providers/               # AI提供商实现
│   ├── base.js              # 提供商基类
│   ├── openai.js            # OpenAI实现
│   ├── claude.js            # Claude实现
│   ├── proxy.js             # 后端代理实现
│   └── index.js             # 提供商管理器
└── context/                 # 上下文管理
    ├── log_collector.js     # 日志收集器
    ├── tutorial_detector.js # 教程内容检测
    └── index.js             # 上下文管理器
```

---

## 核心文件说明

### config.js
**功能定位**: AI助手的全局配置管理中心

**主要职责**:
- 管理API配置（模式、提供商、密钥、模型参数）
- 管理功能开关（日志分析、教程识别、自动建议）
- 管理上下文设置（历史消息数、日志上下文条数）
- 配置的持久化（localStorage）
- 配置导入/导出

**关键配置项**:
- `apiMode`: 'direct'(直连) | 'proxy'(后端转发)
- `provider`: 'openai' | 'claude' | 'custom'
- `apiConfig`: 各提供商的API密钥和参数
- `features`: 功能开关
- `context`: 上下文相关设置

**业务关联**:
- 上游: 设置界面、AI聊天界面
- 下游: 所有需要读取配置的模块

---

### ai-chat.css
**功能定位**: AI聊天框的视觉样式和动画效果

**主要内容**:
- 聊天框容器样式（左侧滑出、1/3屏幕宽度）
- 消息气泡样式（用户/AI区分）
- 输入区域样式
- 加载动画
- 设置面板样式
- 滚动条样式
- 深色主题适配

**设计特点**:
- 使用CSS变量支持主题切换
- 响应式布局适配移动端
- 平滑的过渡动画

---

### ai_chat.js
**功能定位**: AI聊天框的UI交互逻辑

**主要职责**:
- 创建和管理聊天框DOM结构
- 处理用户输入和消息发送
- 消息展示和流式响应更新
- 快捷按钮功能
- 工具栏功能（日志/页面上下文开关、设置、清空）
- 与AI提供商的交互

**关键方法**:
- `init()`: 初始化聊天模块
- `open()/close()/toggle()`: 控制聊天框显隐
- `_sendMessage()`: 发送消息并处理响应
- `_addMessage()`: 添加消息到界面
- `_updateStreamingMessage()`: 流式更新消息

**业务关联**:
- 上游: 用户点击Logo触发
- 下游: AIProviderManager、AIContextManager

---

### index.js
**功能定位**: AI模块的统一入口和初始化

**主要职责**:
- 整合所有AI子模块
- 提供统一的初始化接口
- 暴露公共API给主应用
- 自动初始化（DOM加载完成后）

**公共API**:
- `AIManager.init()`: 手动初始化
- `AIManager.openChat()`: 打开聊天框
- `AIManager.closeChat()`: 关闭聊天框
- `AIManager.toggleChat()`: 切换聊天框
- `AIManager.getConfig()`: 获取配置
- `AIManager.getLogStats()`: 获取日志统计
- `AIManager.analyzeStatus()`: 分析当前状态

**业务关联**:
- 上游: 主应用（index.html）
- 下游: 所有AI子模块

---

## providers/ 目录

### base.js
**功能定位**: AI提供商的抽象基类

**设计目的**:
- 定义所有提供商必须实现的接口
- 提供通用的请求构建方法
- 便于扩展新的AI提供商

**抽象方法**:
- `chat(messages, options)`: 发送聊天请求
- `chatStream(messages, onChunk, options)`: 流式聊天请求
- `validateConfig()`: 验证配置有效性
- `getModels()`: 获取可用模型列表

**通用方法**:
- `buildHeaders()`: 构建请求头
- `buildRequestBody()`: 构建请求体
- `formatMessages()`: 格式化消息
- `parseResponse()`: 解析响应

---

### openai.js
**功能定位**: OpenAI API的具体实现

**支持模型**:
- GPT-4o (最智能)
- GPT-4o Mini (快速经济)
- GPT-4 Turbo (强大的多模态)
- GPT-3.5 Turbo (性价比之选)

**实现特点**:
- 标准OpenAI API格式
- 支持流式响应（SSE）
- 支持系统提示词

**业务关联**:
- 继承: BaseAIProvider
- 上游: AIProviderManager
- 下游: OpenAI API

---

### claude.js
**功能定位**: Anthropic Claude API的具体实现

**支持模型**:
- Claude 3 Opus (最强大的模型)
- Claude 3 Sonnet (平衡性能与速度)
- Claude 3 Haiku (最快响应)

**实现特点**:
- Anthropic API格式
- 特殊的消息格式转换（system消息处理）
- 支持流式响应

**业务关联**:
- 继承: BaseAIProvider
- 上游: AIProviderManager
- 下游: Anthropic API

---

### proxy.js
**功能定位**: 后端代理模式实现

**使用场景**:
- 用量限制管理
- API密钥保护（不在前端暴露密钥）
- 统一的后端处理

**实现特点**:
- 通过`pywebview.api`调用后端
- 支持流式响应（后端分块返回）
- 无需前端配置API密钥

**业务关联**:
- 继承: BaseAIProvider
- 上游: AIProviderManager
- 下游: main.py后端API（需实现）

---

### index.js
**功能定位**: AI提供商管理器

**主要职责**:
- 注册所有可用的提供商
- 根据配置返回对应的提供商实例
- 管理提供商的生命周期
- 提供提供商相关的查询接口

**关键方法**:
- `register(name, ProviderClass)`: 注册提供商
- `getProvider(name, config)`: 获取指定提供商
- `getCurrentProvider()`: 获取当前配置的提供商
- `getAvailableProviders()`: 获取所有可用提供商列表
- `validateCurrentConfig()`: 验证当前配置

**业务关联**:
- 上游: AIChat、AIManager
- 下游: 各具体提供商实现

---

## context/ 目录

### log_collector.js
**功能定位**: 软件运行日志的收集和分析

**主要职责**:
- 拦截console方法捕获日志
- 监听后端推送的日志
- 解析日志内容提取关键信息
- 提供日志查询和分析接口

**关键功能**:
- 日志级别识别（info/warn/error/debug）
- 日志类型识别（success/error/warning/scan/install/telemetry）
- 关键词提取
- 问题分析（错误统计、模式检测）

**关键方法**:
- `init()`: 初始化日志拦截
- `getRecentLogs(count, filter)`: 获取最近日志
- `getFormattedLogs(count)`: 获取格式化的日志文本
- `analyzeIssues()`: 分析日志中的问题

**业务关联**:
- 上游: 软件日志系统
- 下游: AIContextManager

---

### tutorial_detector.js
**功能定位**: 当前页面功能内容的检测和识别

**主要职责**:
- 识别当前活动的功能页面
- 提供页面功能描述和提示
- 提取页面硬编码文字内容
- 为AI提供软件功能上下文

**已知页面**:
- `page-home`: 主页
- `page-lib`: 语音包库
- `page-camo`: 副功能库（涂装）
- `page-sight`: 信息库（炮镜）
- `page-settings`: 设置

**关键方法**:
- `getCurrentPageTutorial()`: 获取当前页面教程信息
- `getCurrentPageContent()`: 获取当前页面内容
- `getContextForAI()`: 获取AI可用的上下文文本
- `isFeatureAvailable(feature)`: 检测功能是否可用

**业务关联**:
- 上游: 软件各功能页面
- 下游: AIContextManager

---

### index.js
**功能定位**: AI上下文管理器

**主要职责**:
- 整合所有上下文信息（日志、教程、用户状态）
- 构建系统提示词
- 构建用户消息上下文
- 构建完整的消息数组供AI请求使用

**关键方法**:
- `init()`: 初始化上下文管理器
- `buildSystemPrompt(options)`: 构建系统提示词
- `buildUserContext(message, options)`: 构建用户上下文
- `buildMessages(userMessage, history, options)`: 构建完整消息数组
- `getQuickAnalysis()`: 快速分析当前状态

**上下文选项**:
- `includeLogs`: 是否包含日志上下文
- `includeTutorial`: 是否包含页面教程上下文
- `logAnalysis`: 是否启用日志分析模式
- `tutorialMode`: 是否启用教程解释模式

**业务关联**:
- 上游: LogCollector、TutorialDetector
- 下游: AIChat、AIProvider

---

## 数据流向

```
用户点击Logo
    ↓
ai_chat.js (UI层)
    ↓
AIContextManager (构建上下文)
    ├── LogCollector (日志)
    └── TutorialDetector (页面内容)
    ↓
AIProviderManager (选择提供商)
    ├── OpenAIProvider
    ├── ClaudeProvider
    └── ProxyProvider
    ↓
AI API (实际请求)
    ↓
流式响应 → ai_chat.js 更新UI
```

---

## 扩展指南

### 添加新的AI提供商

1. 在 `providers/` 下创建新的提供商文件
2. 继承 `BaseAIProvider` 基类
3. 实现必需的抽象方法
4. 在 `providers/index.js` 中注册

示例:
```javascript
class MyProvider extends BaseAIProvider {
    constructor(config) {
        super(config);
        this.name = 'myprovider';
        this.label = 'My Provider';
    }
    
    async chat(messages, options) {
        // 实现请求逻辑
    }
    
    validateConfig() {
        // 实现配置验证
    }
}
```

### 添加新的上下文源

1. 在 `context/` 下创建新的收集器
2. 在 `context/index.js` 中集成
3. 在 `buildSystemPrompt` 中添加使用

### 修改聊天框UI

- 样式修改: `ai_chat.css`
- 交互逻辑修改: `ai_chat.js`
- 无需修改其他文件

---

## 配置示例

### 直连OpenAI
```javascript
{
    apiMode: 'direct',
    provider: 'openai',
    apiConfig: {
        openai: {
            baseUrl: 'https://api.openai.com/v1',
            apiKey: 'sk-xxx',
            model: 'gpt-4o-mini',
            temperature: 0.7,
            maxTokens: 2048
        }
    }
}
```

### 后端代理模式
```javascript
{
    apiMode: 'proxy',
    provider: 'proxy'
    // 无需前端配置密钥
}
```

### 自定义API（OpenAI兼容格式）
```javascript
{
    apiMode: 'direct',
    provider: 'custom',
    apiConfig: {
        custom: {
            baseUrl: 'https://api.example.com/v1',
            apiKey: 'xxx',
            model: 'gpt-4',
            temperature: 0.7,
            maxTokens: 2048
        }
    }
}
```

---

## 注意事项

1. **安全性**: 直连模式下API Key存储在localStorage，生产环境建议使用代理模式
2. **隐私**: 日志可能包含敏感路径信息，发送给AI前会进行过滤
3. **性能**: 日志收集器最多缓存100条日志，避免内存泄漏
4. **兼容性**: 流式响应需要浏览器支持ReadableStream

---

## 版本历史

- v1.0.0 (2026-02-17): 初始版本
  - 支持OpenAI、Claude、自定义API、后端代理
  - 日志收集和页面上下文
  - 流式响应
  - 主题适配
